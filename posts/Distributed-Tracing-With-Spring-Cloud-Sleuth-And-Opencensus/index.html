<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Distributed Tracing with Spring Cloud Sleuth and Opencensus" /><meta name="author" content="Malike St Lewis" /><meta property="og:locale" content="en" /><meta name="description" content="1. What’s Distributed Tracing?" /><meta property="og:description" content="1. What’s Distributed Tracing?" /><link rel="canonical" href="/posts/Distributed-Tracing-With-Spring-Cloud-Sleuth-And-Opencensus/" /><meta property="og:url" content="/posts/Distributed-Tracing-With-Spring-Cloud-Sleuth-And-Opencensus/" /><meta property="og:site_name" content="Malike St" /><meta property="og:image" content="https://raw.githubusercontent.com/malike/malike-media/main/posts/microservices-and-monolithic.png" /><meta property="og:image:height" content="500" /><meta property="og:image:width" content="800" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-04-09T00:00:00+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://raw.githubusercontent.com/malike/malike-media/main/posts/microservices-and-monolithic.png" /><meta property="twitter:title" content="Distributed Tracing with Spring Cloud Sleuth and Opencensus" /><meta name="twitter:site" content="@malike_st" /><meta name="twitter:creator" content="@malike_st" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Malike St Lewis","url":"https://github.com/malike/"},"dateModified":"2022-09-16T20:31:41+02:00","datePublished":"2018-04-09T00:00:00+02:00","description":"1. What’s Distributed Tracing?","headline":"Distributed Tracing with Spring Cloud Sleuth and Opencensus","image":{"width":800,"height":500,"url":"/posts/microservices-and-monolithic.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Distributed-Tracing-With-Spring-Cloud-Sleuth-And-Opencensus/"},"url":"/posts/Distributed-Tracing-With-Spring-Cloud-Sleuth-And-Opencensus/"}</script><title>Distributed Tracing with Spring Cloud Sleuth and Opencensus | Malike St</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Malike St"><meta name="application-name" content="Malike St"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://raw.githubusercontent.com/malike/malike-media/main/common/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Malike St</a></div><div class="site-subtitle font-italic">Tech & stuff</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/sre/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>SRE</span> </a><li class="nav-item"> <a href="/distributed/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>DISTRIBUTED SYSTEMS</span> </a><li class="nav-item"> <a href="/electronics/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ELECTRONICS</span> </a><li class="nav-item"> <a href="/oss/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>OS PROJECTS I STARTED</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/malike" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://gitlab.com/malike" aria-label="gitlab" target="_blank" rel="noopener"> <i class="fab fa-gitlab"></i> </a> <a href="https://twitter.com/malike_st" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['st.malike','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Distributed Tracing with Spring Cloud Sleuth and Opencensus</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Distributed Tracing with Spring Cloud Sleuth and Opencensus</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1523224800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 9, 2018 </em> </span> <span> Updated <em class="" data-ts="1663353101" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 16, 2022 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 500'%3E%3C/svg%3E" data-src="https://raw.githubusercontent.com/malike/malike-media/main/posts/microservices-and-monolithic.png" class="preview-img bg" alt="Preview Image" width="800" height="500" data-proofer-ignore></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/malike/">Malike St Lewis</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1521 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><h4 id="1-whats-distributed-tracing"><span class="mr-2">1. What’s Distributed Tracing?</span><a href="#1-whats-distributed-tracing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Assume you’ve designed your application using a microservice architecture and for a feature like signup you have:</p><p><strong><em>a. service that creates the user in the database,<br /></em></strong> <strong><em>b. …another service that send an event to a messaging queue,<br /></em></strong> <strong><em>c. and finally a service to send an email to the user reacting to the event created in the messaging queue.<br /></em></strong></p><p>FYI this is just signup. <em>(BTW I don’t recommend starting a project like this unless it’s an already existing project you’ve decided to break apart but I’ll leave that for another day).</em></p><p>Monitoring can be a problem since requests can propagate between multiple services, probably running on different containers/hosts. In a <em>“pure”</em> microservice system the services might not even be sharing resources like database. How then can we explain or know that although Kofi Mensah’s account details were successfully created by the signup service, the emailing service failed to send an email to Kofi Mensah without having to <em>grep</em> through multiple log files across different hosts. With this particular example it’s not that our emailing service stopped working or wasn’t running, it just didn’t send email to Kofi Mensah but probably sent an email to another user after.</p><p>This is where distributed tracing comes in. As a request propagates between multiple services it leaves a trace which can be used to track the life cycle of the request.</p><p><em>Whats a trace?</em></p><p>A trace is just a record of how a request is propagated between services, the life cycle of a request. This is normally a collection of spans depending on the journey of the request. A span is the smallest unit in distributed tracing, it normally consists of an id,parent id to indicate if span is connected to another and tags to give more information on the span and other meta data.</p><p>There are so many tools for recording and visualizing traces , eg <a href="https://github.com/jaegertracing">Jaeger</a>, <a href="http://opentracing.io/">OpenTracing</a>, <a href="https://opencensus.io/">Opencensus</a> etc.. but this post is focused on two of them, Opencensus and <a href="https://cloud.spring.io/spring-cloud-sleuth/">Spring Cloud Sleuth</a> and how to visualize trace data in <a href="https://www.elastic.co/products/kibana">Kibana</a> and <a href="https://zipkin.io/">Zipkin</a>.</p><p><em>Zipkin is a distributed tracing system. It helps gather timing data needed to troubleshoot latency problems in microservice architectures. It manages both the collection and lookup of this data. Zipkin’s design is based on the <a href="http://research.google.com/pubs/pub36356.html">Google Dapper paper</a></em></p><p>Added to these, Zipkin also has a <a href="https://zipkin.io/zipkin-api/">Rest API</a>, two version of it <a href="https://zipkin.io/zipkin-api/zipkin-api.yaml">v1</a> and <a href="https://zipkin.io/zipkin-api/zipkin2-api.yaml">v2</a>. This makes Zipkin a polyglot server for visualizing traces and effectively see the intercommunication of your services. Hard to find a language that doesn’t support REST.</p><p>But what if we want more, for example visualize more data from traces and understand little more of our services in production that we can’t get from logs. This is where the <a href="https://www.elastic.co/elk-stack">ELK stack</a> comes in. The ELK stack is really awesome and if you don’t know about it you can read more on it with a Google search.</p><p>Since the goal of this post is to find ways to understand traces for your system, I’ll show how to use two distributed tracing libraries to send trace data to Zipkin and the ELK stack.</p><p>The sample applications would help us understand what each library,that is Sleuth and Opencensus, give us and how sending the trace to Zipkin and/or ELK can help us understand our distributed systems in production and the value each framework brings to the overall goal.</p><h4 id="2-distributed-tracing-tools"><span class="mr-2">2. Distributed Tracing tools</span><a href="#2-distributed-tracing-tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong><em>a. Using Spring Cloud Sleuth</em></strong></p><p>For Java/Kotlin projects using the <a href="https://spring.io/">Spring</a> stack it should be quite easy to get started with this. Since this requires almost nothing to get it started with. You can check out the sample project from <a href="https://github.com/malike/distributed-tracing">github</a>.</p><p>My reason for picking Spring Cloud Sleuth is the simplicity. It requires almost nothing to set it up and once you have the dependency as part of your project it automatically does the tracing for you.</p><p>The dependency which you can find below:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-sleuth<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><p><strong><em>b. Using Opencensus</em></strong></p><p>This an opensource distributed tracing tool started <a href="https://opensource.googleblog.com/2018/01/opencensus.html">Google</a>.</p><p>The reason I picked this was in as much as the “magic” that Spring Cloud Sleuth is, there might be certain uses magic won’t work and also one that is not dependent on the Spring stack and not only limited to the JVM. This is where Opencensus comes in.</p><h4 id="4-why-an-elasticsearch-trace-exporter"><span class="mr-2">4. Why an Elasticsearch Trace Exporter</span><a href="#4-why-an-elasticsearch-trace-exporter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>I love the ELK stack. I’ve used all or parts of it for operational analysis, data analytics,data lake,data warehouse, data prediction in different projects. I’ve actually written some FOSS projects for Elasticsearch as well.</p><p>One of the ways I love to work on FOSS projects is that at the end of it all, I want anyone to be able to use a combination of my opensource projects. So I try to find ways to link all the FOSS projects I work on.</p><p>I picked Elasticsearch based on my past experience with it, Kibana gives us so much power to visualize the data in Elasticsearch and some of the FOSS projects I’ve worked on which when put together can enable someone generate trace data reports <a href="http://malike.github.io/elasticsearch-report-engine">pdf,csv or html</a>, configure alerts based on certain metrics via <a href="https://malike.github.io/go-kafka-alert/">sms,email and api</a> and also build an <a href="https://malike.github.io/elasticsearch-recommendation-engine/">ML algorithm</a> on trace data to predict performance of your services.</p><p>From the FOSS links you can tell some of them are still in progress but you get the idea connecting them.</p><p>The best reason of all is search. Being able to search traces to know why <em><strong>a service request took 20 secs on Monday 21st September at 3:43 PM for Kofi accessing the service from Tokyo rather than the 5 seconds we have as SLA for response time</strong></em>. This possible with Elasticsearch.</p><p><strong><em>a. Spring Cloud Sleuth Elasticsearch Exporter</em></strong> *</p><p>Spring Cloud Sleuth doesn’t support exporting to Elasticsearch. So this might be a little confusing. To send trace data from a Spring Boot project to the ELK stack would require <a href="https://www.elastic.co/products/logstash">Logstash</a>. The <strong>“L”</strong> in the <strong>ELK</strong>.</p><p><em>Logstash is an open source, server-side data processing pipeline that ingests data from a multitude of sources simultaneously, transforms it, and then sends it to your favorite “stash.”</em></p><p>In our case the stash is Elasticsearch. You can find the logstash config we used for our sample project <a href="https://github.com/malike/distributed-tracing/blob/master/spring-cloud-sleuth/src/main/resources/logback.xml">here</a>. A simple config that sends logs in a particular format to logstash running on <code class="language-plaintext highlighter-rouge">127.0.0.1</code> port <code class="language-plaintext highlighter-rouge">5000</code> from the config file.</p><p><a href="Sample Kibana Dashboard from trace"><img data-src="https://raw.githubusercontent.com/malike/distributed-tracing/master/spring-cloud-sleuth/distributed_tracing_3.png" data-proofer-ignore></a></p><p><strong>b. Opencensus Elasticsearch Exporter</strong></p><p>Opencensus doesn’t have an Elasticsearch exporter either. I’ve worked on and submitted a PR to the Opencensus team. Once it gets accepted and released you can find more details on it under the exporters in <a href="https://github.com/census-instrumentation/opencensus-java">Opencensus</a>.</p><p>For now you can check out on my personal <a href="https://github.com/malike/opencensus-java">github</a> for the Elasticsearch exporter I wrote for Opencensus.</p><p><a href="Sample Opencensus trace exported to Elasticsearch"><img data-src="https://raw.githubusercontent.com/malike/distributed-tracing/master/opencensus/distributed_tracing_elk_discover.png?raw=https://raw.githubusercontent.com/malike/malike-media/maintrue" data-proofer-ignore></a></p><h4 id="5-why-an-zipkin-trace-exporter"><span class="mr-2">5. Why an Zipkin Trace Exporter</span><a href="#5-why-an-zipkin-trace-exporter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Spring Cloud has a simple way of starting a Zipkin server. This is actually based on <a href="https://github.com/openzipkin">OpenZipkin</a> which originated from Twitter.</p><p>Using it is as simple as using the annotation <code class="language-plaintext highlighter-rouge">@EnableZipkinServer</code> on our main class. From the Spring Cloud Zipkin documentation:</p><p><em>The Zipkin Server delegates writes to the persistence tier via a SpanStore. Presently, there is support for using MySQL or an in-memory SpanStore out-of-the-box. As an alternative to REST, we can also publish messages to the Zipkin server over a Spring Cloud Stream binder like RabbitMQ or Apache Kafka. We’ll use this option, and <code class="language-plaintext highlighter-rouge">org.springframework.cloud:spring-cloud-sleuth-zipkin-stream</code>’s <code class="language-plaintext highlighter-rouge">@EnableZipkinStreamServer</code>, to adapt incoming Spring Cloud Stream-based Sleuth Spans into Zipkin’s Spans and then persist them using the SpanStore.</em></p><p>This is really cool especially if you’re the type that’s really strict on <em>“REST intercommunication between internal services is bad”</em> or just prefer <em>TCP</em> to <em>HTTP</em> for recording traces.</p><p><strong><em>a. Spring Cloud Sleuth Zipkin Exporter</em></strong></p><p>To get our sample Spring Cloud Sleuth to send trace data to Zipkin is just to add this line in our properties file</p><p>1.Where our zipkin server is located</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s">spring.zipkin.baseUrl=http://localhost:9411</span>
</pre></table></code></div></div><p>2.To enable this functionality in our app and also make sure we have this dependency</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-sleuth-zipkin<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><p>There’s also another configuration to check the percentage of data we send to zipkin. The default is 10%. If you want 50% just add this to your properties file. Note that although it is a percentage, the accepted value is a <code class="language-plaintext highlighter-rouge">double</code> between <code class="language-plaintext highlighter-rouge">0.1</code> to <code class="language-plaintext highlighter-rouge">1.0</code> where <code class="language-plaintext highlighter-rouge">0.1</code> is <code class="language-plaintext highlighter-rouge">10%</code>.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s">spring.sleuth.sampler.probability=0.5</span>
</pre></table></code></div></div><p>If you’re already on Spring Boot 2.0 you can also use annotations to create our own spans. You can find an example of this usage on <a href="https://github.com/malike/distributed-tracing/tree/master/spring-cloud-sleuth">github</a> and also read more on it <a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-sleuth/2.0.0.M9/single/spring-cloud-sleuth.html#_sleuth_with_zipkin_via_http">here</a>. This requires these dependencies or later:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-sleuth<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0.M9<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-sleuth-zipkin<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0.M9<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><p><strong><em>b. Opencensus Zipkin Exporter</em></strong></p><p>The team at Opencensus already wrote a zipkin exporter with an example on how to export trace data with it. You can find the documentation and codes <a href="https://github.com/census-instrumentation/opencensus-java/tree/master/exporters/trace/zipkin">here</a>.</p><p>Hopefully with this post I hope you can appreciate what each library gives us and the part Zipkin and ELK stack play in visualizing traces in a distributed system and can help you make a decision with the attached sample project.</p><p><a href="Sample traces on Zipkin"><img data-src="https://github.com/malike/distributed-tracing/blob/master/spring-cloud-sleuth/distributed_tracing_1.png?raw=https://raw.githubusercontent.com/malike/malike-media/maintrue" data-proofer-ignore></a></p><blockquote><p>Codes are available on <a href="https://github.com/malike/distributed-tracing.git">github</a></p></blockquote><p><br /> <br /> <strong>REFERENCES</strong></p><p><a href="http://microservices.io/patterns/observability/distributed-tracing.html">http://microservices.io/patterns/observability/distributed-tracing.html</a></p><p><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-sleuth/2.0.0.M9/single/spring-cloud-sleuth.html">https://cloud.spring.io/spring-cloud-static/spring-cloud-sleuth/2.0.0.M9/single/spring-cloud-sleuth.html</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/distributed/'>distributed</a>, <a href='/categories/sre/'>sre</a>, <a href='/categories/foss/'>foss</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/distributed/" class="post-tag no-text-decoration" >distributed</a> <a href="/tags/tracing/" class="post-tag no-text-decoration" >tracing</a> <a href="/tags/opencensus/" class="post-tag no-text-decoration" >opencensus</a> <a href="/tags/elasticsearch/" class="post-tag no-text-decoration" >elasticsearch</a> <a href="/tags/microservice/" class="post-tag no-text-decoration" >microservice</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Distributed+Tracing+with+Spring+Cloud+Sleuth+and+Opencensus+-+Malike+St&url=%2Fposts%2FDistributed-Tracing-With-Spring-Cloud-Sleuth-And-Opencensus%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Distributed+Tracing+with+Spring+Cloud+Sleuth+and+Opencensus+-+Malike+St&u=%2Fposts%2FDistributed-Tracing-With-Spring-Cloud-Sleuth-And-Opencensus%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FDistributed-Tracing-With-Spring-Cloud-Sleuth-And-Opencensus%2F&text=Distributed+Tracing+with+Spring+Cloud+Sleuth+and+Opencensus+-+Malike+St" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Predicting-Customer-Purchases-Beginners-Guide/">Predicting Customer Purchases: A Beginner's Guide to E-Commerce Data Science</a><li><a href="/posts/Obersevability-Stack-with-Grafana-Loki-And-Tempo/">Observability Stack with Grafana Loki Tempo and Prometheus</a><li><a href="/posts/Apache-Kafka-On-Kubernetes-Strimzi-Operator/">Apache Kafka on Kubernetes with Strimzi Operator</a><li><a href="/posts/Annotations+Spring=Awesome/">Java Annotations + Spring = Awesome</a><li><a href="/posts/Lambda-Architecture-RT/">Lambda Architecture With Kafka, ElasticSearch, Apache Storm and MongoDB</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/documentation/">documentation</a> <a class="post-tag" href="/tags/sample/">sample</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/distributed/">distributed</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a> <a class="post-tag" href="/tags/microservice/">microservice</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/k8s/">k8s</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Configuration-Management-For-Microservices-And-Distributed-Systems/"><div class="card-body"> <em class="small" data-ts="1527890400" data-df="ll" > Jun 2, 2018 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configuration Management for Microservices</h3><div class="text-muted small"><p> Centralized configuration management is one of the major requirements in a microservice system. Although one of the major proponents of a microservice system is decentralized services, certain part...</p></div></div></a></div><div class="card"> <a href="/posts/CI-CD-AWS-Infrastructure-For-Kubernetes-Cluster-Using-CloudFormation/"><div class="card-body"> <em class="small" data-ts="1548975600" data-df="ll" > Feb 1, 2019 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Continuous Integration, continuous Deployment with AWS Using EKS, CodeBuild, CodePipeline, ECR and CloudFormation</h3><div class="text-muted small"><p> Building up on our previous article, where a simple cloud native/ distributed system application was built to run on kubernetes using Travis CI, DockerHub locally. What if we move this infrastructu...</p></div></div></a></div><div class="card"> <a href="/posts/K8s-101-And-Istio-Service-Mesh/"><div class="card-body"> <em class="small" data-ts="1539208800" data-df="ll" > Oct 11, 2018 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Beginning Kubernetes and Istio Service Mesh for Cloud Native/Distributed Systems</h3><div class="text-muted small"><p> 1. Kubernetes [K8S] The Processes factor of 12 factors which means having stateless services, that can be easily scaled by deploying multiple instances of the same service. Deploying and managemen...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Elasticsearch-Report-Engine/" class="btn btn-outline-primary" prompt="Older"><p>Elasticsearch Report Engine</p></a> <a href="/posts/Configuration-Management-For-Microservices-And-Distributed-Systems/" class="btn btn-outline-primary" prompt="Newer"><p>Configuration Management for Microservices</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/malike_st">Malike St</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/documentation/">documentation</a> <a class="post-tag" href="/tags/sample/">sample</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/distributed/">distributed</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a> <a class="post-tag" href="/tags/microservice/">microservice</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/k8s/">k8s</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-66835539-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-66835539-1'); }); </script>
