<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Kubernetes Secrets Store CSI Driver POC" /><meta name="author" content="Malike St Lewis" /><meta property="og:locale" content="en" /><meta name="description" content="Kubernetes Secrets Store CSI Driver POC" /><meta property="og:description" content="Kubernetes Secrets Store CSI Driver POC" /><link rel="canonical" href="/posts/Kubernetes-Secrets-Store-CSI-Driver-PoC/" /><meta property="og:url" content="/posts/Kubernetes-Secrets-Store-CSI-Driver-PoC/" /><meta property="og:site_name" content="Malike St" /><meta property="og:image" content="https://raw.githubusercontent.com/malike/malike-media/main/posts/robotic_garage.png" /><meta property="og:image:height" content="500" /><meta property="og:image:width" content="800" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-18T00:00:00+01:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://raw.githubusercontent.com/malike/malike-media/main/posts/robotic_garage.png" /><meta property="twitter:title" content="Kubernetes Secrets Store CSI Driver POC" /><meta name="twitter:site" content="@malike_st" /><meta name="twitter:creator" content="@malike_st" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Malike St Lewis","url":"https://github.com/malike/"},"dateModified":"2022-01-18T00:00:00+01:00","datePublished":"2022-01-18T00:00:00+01:00","description":"Kubernetes Secrets Store CSI Driver POC","headline":"Kubernetes Secrets Store CSI Driver POC","image":{"width":800,"height":500,"url":"/posts/robotic_garage.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Kubernetes-Secrets-Store-CSI-Driver-PoC/"},"url":"/posts/Kubernetes-Secrets-Store-CSI-Driver-PoC/"}</script><title>Kubernetes Secrets Store CSI Driver POC | Malike St</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Malike St"><meta name="application-name" content="Malike St"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://raw.githubusercontent.com/malike/malike-media/main/common/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Malike St</a></div><div class="site-subtitle font-italic">Tech & stuff</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/sre/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>SRE</span> </a><li class="nav-item"> <a href="/distributed/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>DISTRIBUTED SYSTEMS</span> </a><li class="nav-item"> <a href="/electronics/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ELECTRONICS</span> </a><li class="nav-item"> <a href="/oss/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>OS PROJECTS I STARTED</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/malike" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://gitlab.com/malike" aria-label="gitlab" target="_blank" rel="noopener"> <i class="fab fa-gitlab"></i> </a> <a href="https://twitter.com/malike_st" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['st.malike','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Kubernetes Secrets Store CSI Driver POC</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Kubernetes Secrets Store CSI Driver POC</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1642460400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 18, 2022 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 500'%3E%3C/svg%3E" data-src="https://raw.githubusercontent.com/malike/malike-media/main/posts/robotic_garage.png" class="preview-img bg" alt="Preview Image" width="800" height="500" data-proofer-ignore></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/malike/">Malike St Lewis</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1145 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><h1 id="kubernetes-secrets-store-csi-driver-poc">Kubernetes Secrets Store CSI Driver POC</h1><p><a href="https://kubernetes.io/blog/2019/01/15/container-storage-interface-ga/">Container Storage Interface</a> is a standard for exposing arbitaryy block and file storage systems to containerized workloads in Kubernetes. There various third-party uses of the Container Storage Interface.</p><p>The <a href="https://github.com/kubernetes-sigs/secrets-store-csi-driver">Secrets Store CSI driver</a> is just one of the many drivers that takes advantage of the Container Storage Interface. It uses a list of compartible providers to make secrets managed <em>outside</em> Kubernetes available <em>in</em> Kubernetes via Container Storage Interface.</p><p>There are a couple of providers supported which can work with Secrets Store CSI driver.</p><ol><li><a href="https://github.com/aws/secrets-store-csi-driver-provider-aws">AWS Provider</a> : For AWS Secrets Manager<li><a href="https://azure.github.io/secrets-store-csi-driver-provider-azure/">Azure Provider</a> : For Azure Key Vault<li><a href="https://github.com/GoogleCloudPlatform/secrets-store-csi-driver-provider-gcp">GCP Provider</a> : For Google Secret Manager<li><a href="https://github.com/hashicorp/secrets-store-csi-driver-provider-vault">Vault Provider</a> : For Hashicorp Vault.</ol><p>This article and POC will focus much more on the Vault Provider. That is the goal of this article is so way to use and manage externalized secrets stored on vault in hte Kubernetes cluster via the Kubernetes-native API.</p><p>What are some advantages of doing this:</p><ol><li>No need to manage clients for where secrets are stored.<li>Secrets Store CSI driver using the native Kubernetes-API means there’ll a more organized way of upgrading during cluster upgrades compared to multiple clients.<li>The abstraction provided by Secrets Store CSI driver makes it easier to build a much more cloud agnostic infrastructure not tied to one Secret manager.<li><a href="https://12factor.net/">The Twelve Factor App</a> guideline for storing secrets as environment variables can be achieved with this.</ol><h3 id="1-architecture"><span class="mr-2">1. Architecture</span><a href="#1-architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We have a simple Go application, that will access secrets stored on vault provisioned by the Secrets Store CSI driver.</p><h3 id="2-set-up"><span class="mr-2">2. Set up</span><a href="#2-set-up" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="1-configure-secrets-store-csi-driver-and-vault-provider"><span class="mr-2">1. Configure Secrets Store CSI driver and Vault Provider</span><a href="#1-configure-secrets-store-csi-driver-and-vault-provider" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>To set up the POC clone the <a href="https://github.com/malike/secrets-store-csi-driver-poc.git">repository</a>.<li>cd into the directory.<li>Make sure you’re connected to the right cluster.<li>Install Secrets Store CSI driver into our cluster by running <code class="language-plaintext highlighter-rouge">make install-csi</code>. This should install the Secrets Store CSI driver into the cluster and also create the namespace <code class="language-plaintext highlighter-rouge">dev-csi-poc</code>.<li>Install the <a href="https://github.com/hashicorp/secrets-store-csi-driver-provider-vault">Vault Provider</a> using <code class="language-plaintext highlighter-rouge">make setup-vault-provider</code>. The deployment manifest for the Vault Provider looks like this.<div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vault-csi-provider</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">dev-csi-poc</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vault-csi-provider-clusterrole</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">serviceaccounts/token</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">create</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vault-csi-provider-clusterrolebinding</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vault-csi-provider-clusterrole</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vault-csi-provider</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">dev-csi-poc</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DaemonSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
<span class="err"> </span><span class="na">app</span><span class="pi">:</span> <span class="s">vault-csi-provider</span>
  <span class="s">name</span><span class="err">:</span> <span class="s">vault-csi-provider</span>
  <span class="s">namespace</span><span class="err">:</span> <span class="s">dev-csi-poc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">updateStrategy</span><span class="pi">:</span>
<span class="err"> </span><span class="na">type</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
  <span class="s">selector</span><span class="err">:</span>
 <span class="na">matchLabels</span><span class="pi">:</span>
   <span class="na">app</span><span class="pi">:</span> <span class="s">vault-csi-provider</span>
  <span class="na">template</span><span class="pi">:</span>
 <span class="na">metadata</span><span class="pi">:</span>
   <span class="na">labels</span><span class="pi">:</span>
     <span class="na">app</span><span class="pi">:</span> <span class="s">vault-csi-provider</span>
 <span class="na">spec</span><span class="pi">:</span>
   <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">vault-csi-provider</span>
   <span class="na">tolerations</span><span class="pi">:</span>
   <span class="na">containers</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">provider-vault-installer</span>
       <span class="na">image</span><span class="pi">:</span> <span class="s">hashicorp/vault-csi-provider:0.3.0</span>
       <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Always</span>
       <span class="na">args</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s">--endpoint=/provider/vault.sock</span>
         <span class="pi">-</span> <span class="s">--debug=false</span>
       <span class="na">resources</span><span class="pi">:</span>
         <span class="na">requests</span><span class="pi">:</span>
           <span class="na">cpu</span><span class="pi">:</span> <span class="s">50m</span>
           <span class="na">memory</span><span class="pi">:</span> <span class="s">100Mi</span>
         <span class="na">limits</span><span class="pi">:</span>
           <span class="na">cpu</span><span class="pi">:</span> <span class="s">50m</span>
           <span class="na">memory</span><span class="pi">:</span> <span class="s">100Mi</span>
       <span class="na">volumeMounts</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">providervol</span>
           <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/provider"</span>
         <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mountpoint-dir</span>
           <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/kubelet/pods</span>
           <span class="na">mountPropagation</span><span class="pi">:</span> <span class="s">HostToContainer</span>
       <span class="na">livenessProbe</span><span class="pi">:</span>
         <span class="na">httpGet</span><span class="pi">:</span>
           <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/health/ready"</span>
           <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
           <span class="na">scheme</span><span class="pi">:</span> <span class="s2">"</span><span class="s">HTTP"</span>
         <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">2</span>
         <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
         <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">5</span>
         <span class="na">successThreshold</span><span class="pi">:</span> <span class="m">1</span>
         <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">3</span>
       <span class="na">readinessProbe</span><span class="pi">:</span>
         <span class="na">httpGet</span><span class="pi">:</span>
           <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/health/ready"</span>
           <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
           <span class="na">scheme</span><span class="pi">:</span> <span class="s2">"</span><span class="s">HTTP"</span>
         <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">2</span>
         <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
         <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">5</span>
         <span class="na">successThreshold</span><span class="pi">:</span> <span class="m">1</span>
         <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">3</span>
   <span class="na">volumes</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">providervol</span>
       <span class="na">hostPath</span><span class="pi">:</span>
         <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/etc/kubernetes/secrets-store-csi-providers"</span>
     <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mountpoint-dir</span>
       <span class="na">hostPath</span><span class="pi">:</span>
         <span class="na">path</span><span class="pi">:</span> <span class="s">/var/lib/kubelet/pods</span>
   <span class="na">nodeSelector</span><span class="pi">:</span>
     <span class="na">beta.kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
</pre></table></code></div></div><li>Ensure our Vault installation has Kubernetes <a href="https://www.vaultproject.io/docs/auth/kubernetes">auth enabled</a>.<li>Create a path for our secret, <code class="language-plaintext highlighter-rouge">vault secrets enable -path=service-a kv-v2</code><li>Put in a sample password <code class="language-plaintext highlighter-rouge">vault kv put service-a/database password=secret1234</code> for our made up service.<li>Create a vault policy to enable us read the secrets for our made up service.<pre><code class="language-commandline">vault policy write service-a-policy -&lt;&lt;EOF
path "service-a/data/database" {
capabilities = ["read"]
}
EOF
</code></pre><li>Create a Kubernetes Auth role that grants that allows for the reading of secrets to the service account in a specific namespace.<pre><code class="language-commandline">vault write auth/kubernetes/role/csi \
bound_service_account_names=secrets-store-csi-driver,goservice-csi-serviceaccount,vault-csi-provider \
bound_service_account_namespaces=dev-csi-poc \
policies=service-a-policy ttl=720m
</code></pre></ol><p>Now we’ve set completed the setup Secrets Store CSI driver, Vault Provider and enabled kubernetes auth role to the ServiceAccount in the namesapce <code class="language-plaintext highlighter-rouge">ev-csi-poc</code></p><h4 id="2-deploy-service"><span class="mr-2">2. Deploy Service</span><a href="#2-deploy-service" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The setup is ready for the deployment of the service. The deployment manifest for our simple Go service has a custom resource called <strong>SecretProviderClass</strong>, which was installed when we deployed Secrets Store CSI driver.</p><p>It looks something like this.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">secrets-store.csi.x-k8s.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">SecretProviderClass</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">goservice-vault-provider</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">provider</span><span class="pi">:</span> <span class="s">vault</span>
  <span class="na">parameters</span><span class="pi">:</span>
    <span class="na">roleName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">csi"</span>
    <span class="na">vaultAddress</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://vault.vault:8200"</span>
    <span class="na">vaultSkipTLSVerify</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="na">objects</span><span class="pi">:</span>  <span class="pi">|</span>
      <span class="s">- secretPath: "service-a/data/database"</span>
        <span class="s">objectName: "password"</span>
        <span class="s">secretKey: "password"</span>

</pre></table></code></div></div><p>Few things to note are:</p><ol><li><strong>vaultAddress</strong> : The URL to our vault.<li><strong>roleName</strong> : The kubernetes role created in vault to access the secrets.<li><strong>objects</strong>: Details of the secrets we want to mount.</ol><p>We can also mount multiple secrets, certs in the same cluster.</p><p>Now to use it as environment variables, we mount <strong>SecretProviderClass</strong> as a volume.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>       <span class="na">env</span><span class="pi">:</span>            
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">goservice-store-inline</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/mnt/secrets-store"</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">goservice-store-inline</span>
            <span class="na">csi</span><span class="pi">:</span>
              <span class="na">driver</span><span class="pi">:</span> <span class="s">secrets-store.csi.k8s.io</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
              <span class="na">volumeAttributes</span><span class="pi">:</span>
                <span class="na">secretProviderClass</span><span class="pi">:</span> <span class="s">goservice-vault-provider</span>
</pre></table></code></div></div><p>To deploy this, let’s run <code class="language-plaintext highlighter-rouge">make kube-deploy</code> to install the service into the cluster.</p><h4 id="3-test-setup"><span class="mr-2">3. Test Setup</span><a href="#3-test-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To test we need to confirm if the secret path configured in vault is accessible in the pod.</p><ol><li>Run <code class="language-plaintext highlighter-rouge">kubectl get po -n dev-csi-poc</code> to get pods in the namespace. You should have something like this:</ol><pre><code class="language-commandline">NAME                                               READY   STATUS    RESTARTS   AGE
csi-secrets-store-secrets-store-csi-driver-6zkk7   3/3     Running   0          2m49s
goservice-csi-c8b66664d-kdgjk                      1/1     Running   0          88s
vault-csi-provider-hww87                           1/1     Running   0          2m1s
</code></pre><ol><li>Connect to the pod, with <code class="language-plaintext highlighter-rouge">kubectl exec goservice-csi-c8b66664d-kdgjk -n dev-csi-poc -- ls /mnt/secrets-store</code>. Since we’ve mounted our vault secrets to this path <em>/mnt/secrets-store</em><li>You can proceed and <code class="language-plaintext highlighter-rouge">cat</code> the password to confirm if the secret stored in vault will be accessible. <code class="language-plaintext highlighter-rouge">kubectl exec goservice-csi-c8b66664d-kdgjk -n dev-csi-poc -- cat /mnt/secrets-store/password</code><li>The Go service also provides an httpendpoint to read contents of the file <em>/mnt/secrets-store/password</em>. This can be accessed by getting the NodePort and then accessing the path <code class="language-plaintext highlighter-rouge">/vault</code>. You should see the contents of password file displayed.</ol><p><code class="language-plaintext highlighter-rouge">kubectl get svc -n dev-csi-poc</code> with the output :</p><pre><code class="language-commandline">NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
goservice-csi   NodePort   10.104.91.25   &lt;none&gt;        8080:31510/TCP   12m
</code></pre><p><code class="language-plaintext highlighter-rouge">curl http://localhost:31510/vault</code> as an alternative checkpoint.</p><p>Few things to note, the CSI driver is invoked by kubelet only during the pod volume mount. So subsequent changes in the SecretProviderClass after the pod has started doesn’t trigger an update to the content in volume mount or Kubernetes secret. There’s also a way to enable autorotation of secrets without having to restart the pod. However, this is still in <a href="https://github.com/kubernetes-sigs/secrets-store-csi-driver/blob/55efc2dd1a8b64d7f7961d769c79c8100398a555/docs/book/src/topics/secret-auto-rotation.md">alpha</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devops/'>devops</a>, <a href='/categories/sre/'>sre</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/vault/" class="post-tag no-text-decoration" >vault</a> <a href="/tags/secrets-store-csi/" class="post-tag no-text-decoration" >secrets-store-csi</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Kubernetes+Secrets+Store+CSI+Driver+POC+-+Malike+St&url=%2Fposts%2FKubernetes-Secrets-Store-CSI-Driver-PoC%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Kubernetes+Secrets+Store+CSI+Driver+POC+-+Malike+St&u=%2Fposts%2FKubernetes-Secrets-Store-CSI-Driver-PoC%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FKubernetes-Secrets-Store-CSI-Driver-PoC%2F&text=Kubernetes+Secrets+Store+CSI+Driver+POC+-+Malike+St" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Predicting-Customer-Purchases-Beginners-Guide/">Predicting Customer Purchases: A Beginner's Guide to E-Commerce Data Science</a><li><a href="/posts/Obersevability-Stack-with-Grafana-Loki-And-Tempo/">Observability Stack with Grafana Loki Tempo and Prometheus</a><li><a href="/posts/Apache-Kafka-On-Kubernetes-Strimzi-Operator/">Apache Kafka on Kubernetes with Strimzi Operator</a><li><a href="/posts/Annotations+Spring=Awesome/">Java Annotations + Spring = Awesome</a><li><a href="/posts/Lambda-Architecture-RT/">Lambda Architecture With Kafka, ElasticSearch, Apache Storm and MongoDB</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/documentation/">documentation</a> <a class="post-tag" href="/tags/sample/">sample</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/distributed/">distributed</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a> <a class="post-tag" href="/tags/microservice/">microservice</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/k8s/">k8s</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Starting-With-Kubernetes-Docker-For-Mac-1/"><div class="card-body"> <em class="small" data-ts="1593122400" data-df="ll" > Jun 26, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Introduction to Software Development on Kubernetes - Part 1</h3><div class="text-muted small"><p> 1. Setting up Kubernetes Kubernetes is fast becoming, if not already, the OS for building cloud native applications. As someone put it, “the platform for building platforms”. As such people will w...</p></div></div></a></div><div class="card"> <a href="/posts/Cassandra-DSE-On-Kubernetes-With-Cass-Operator/"><div class="card-body"> <em class="small" data-ts="1644361200" data-df="ll" > Feb 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Taking DataStax Enterprise for a Spin on Kubernetes</h3><div class="text-muted small"><p> 1. Introduction DataStax Enterprise (DSE) version 6.8 a hybrid cloud, that is can run on-premises or across regions on the cloud to give all the capabilities of Apache Cassandra with enterprise to...</p></div></div></a></div><div class="card"> <a href="/posts/Apache-Kafka-On-Kubernetes-Strimzi-Operator/"><div class="card-body"> <em class="small" data-ts="1646434800" data-df="ll" > Mar 5, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Apache Kafka on Kubernetes with Strimzi Operator</h3><div class="text-muted small"><p> Strimzi is a kubernetes operator that enables a way to run an Apache Kafka cluster on Kubernetes in various deployment configurations with simple configurations. Meaning, we easily manage the lifec...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Starting-With-Kubernetes-Docker-For-Mac-1/" class="btn btn-outline-primary" prompt="Older"><p>Introduction to Software Development on Kubernetes - Part 1</p></a> <a href="/posts/Cassandra-DSE-On-Kubernetes-With-Cass-Operator/" class="btn btn-outline-primary" prompt="Newer"><p>Taking DataStax Enterprise for a Spin on Kubernetes</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/malike_st">Malike St</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/documentation/">documentation</a> <a class="post-tag" href="/tags/sample/">sample</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/distributed/">distributed</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a> <a class="post-tag" href="/tags/microservice/">microservice</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/k8s/">k8s</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-66835539-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-66835539-1'); }); </script>
